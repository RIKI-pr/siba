<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIBA Enterprise - Satpel PVP Jambi</title>
    
    <!-- Fonts & Tailwind -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                        serif: ['"Times New Roman"', 'Times', 'serif'],
                    },
                    colors: {
                        primary: { DEFAULT: '#4f46e5', 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        success: '#10b981', warning: '#f59e0b', danger: '#ef4444', info: '#3b82f6'
                    },
                    borderRadius: { DEFAULT: '0.375rem', xl: '0.75rem', '2xl': '1rem' },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)' }
                }
            }
        }
    </script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- QR Code library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- html2canvas & jsPDF for downloading images/PDF -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { background-color: #f8fafc; color: #0f172a; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Print Styling - A4 Configuration */
        @media print { 
            @page { size: A4; margin: 5mm; } 
            body { background: white; -webkit-print-color-adjust: exact; margin: 0; padding: 0; overflow: visible; }
            .no-print, aside, header, .pagination-controls, button, .modal-close-btn, .screen-only-bg, .print-controls { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 0 !important; width: 100% !important; }
            .print-area-wrapper { display: block !important; width: 100% !important; padding: 0 !important; margin: 0 !important; background: white !important; box-shadow: none !important; border: none !important; }
            .a4-page { width: 100% !important; height: auto !important; box-shadow: none !important; margin: 0 !important; border: none !important; padding: 0 !important; }
            .page-break { page-break-before: always; }
            .label-grid { display: grid; grid-template-columns: repeat(4, 1fr) !important; gap: 2mm !important; row-gap: 2mm !important; }
            .label-card { break-inside: avoid; page-break-inside: avoid; border: 2px solid black !important; height: auto !important; }
        }
        
        .print-only { display: none; }
        @media print { .print-only { display: block; } }

        input, select, textarea { font-size: 16px !important; } /* Prevent iOS zoom */
        select.small-text { font-size: 11px !important; }

        /* A4 Preview Helper for Screen */
        .a4-page { width: 210mm; min-height: 297mm; padding: 10mm; margin: 0 auto; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        @media (max-width: 768px) {
            .a4-page { width: 100%; padding: 5mm; min-height: auto; box-shadow: none; border: 1px solid #eee; overflow-x: auto; }
            .label-grid { grid-template-columns: repeat(2, 1fr) !important; } 
        }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, createContext, useContext, useRef } = React;

        // --- UTILS ---
        const cn = (...classes) => classes.filter(Boolean).join(" ");
        const formatCurrency = (val) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        const DEFAULT_LOGO = "https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Lambang_Kementerian_Ketenagakerjaan_RI.png/600px-Lambang_Kementerian_Ketenagakerjaan_RI.png";
        
        // --- ICONS ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                Dashboard: <g><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></g>,
                Package: <g><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></g>,
                Building: <g><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></g>,
                ArrowLeftRight: <g><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></g>,
                Wrench: <g><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></g>,
                FileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></g>,
                Settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2-2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                Search: <g><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></g>,
                Plus: <g><path d="M5 12h14"/><path d="M12 5v14"/></g>,
                Filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>,
                Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></g>,
                Trash: <g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></g>,
                Edit: <g><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></g>,
                Eye: <g><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></g>,
                X: <g><path d="M18 6 6 18"/><path d="m6 6 12 12"/></g>,
                ChevronLeft: <path d="m15 18-6-6 6-6"/>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                Menu: <g><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></g>,
                PanelLeft: <g><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 3v18"/></g>,
                MapPin: <g><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></g>,
                CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>,
                AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></g>,
                Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
                Printer: <g><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></g>,
                User: <g><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
                Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></g>,
                ArrowLeft: <g><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></g>,
                Save: <g><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></g>,
                Database: <g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
                Link: <g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></g>,
                Type: <g><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></g>
            };

            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- CONSTANTS ---
        const INITIAL_DATA = { items: [], rooms: [], loans: [], maintenance: [], logs: [] };
        const INITIAL_SETTINGS = {
            adminName: "Administrator BMN",
            adminNip: "19xxxxxx xxxxx xxxx",
            headName: "Kepala Satpel",
            headNip: "19xxxxxx xxxxx xxxx",
            logoUrl: DEFAULT_LOGO
        };
        const UNIT_OPTIONS = ["Unit", "Buah", "Pcs", "Set", "Lembar", "Batang", "Roll", "Meter", "Pack", "Box", "Kg", "Liter", "Pasang"];

        // --- CONTEXT ---
        const AppContext = createContext();
        const AppProvider = ({ children }) => {
            const [data, setData] = useState(INITIAL_DATA);
            const [appSettings, setAppSettings] = useState(INITIAL_SETTINGS);
            const [scriptUrl, setScriptUrl] = useState(localStorage.getItem('gas_url') || 'https://script.google.com/macros/s/AKfycbzV60dHySLv1HbR6GLRo2BckOTI_5O53dgngx0a9NvXLlhYqsc28nyNn7LxBsmWdvkWWw/exec');
            const [loading, setLoading] = useState(false);
            const [isConnected, setIsConnected] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);

            const updateData = (key, newData) => setData(prev => ({ ...prev, [key]: newData }));

            useEffect(() => {
                if(scriptUrl) localStorage.setItem('gas_url', scriptUrl);
            }, [scriptUrl]);

            const getAvailableStock = (itemId) => {
                const item = data.items.find(i => i.id === itemId);
                if (!item) return 0;
                const onLoan = data.loans
                    .filter(l => l.status === 'Active')
                    .reduce((total, l) => {
                        const loanItem = l.items.find(li => li.id === itemId);
                        return total + (loanItem ? loanItem.qty : 0);
                    }, 0);
                return item.stock - onLoan;
            };

            const addLog = (action, desc) => {
                const newLog = {id: Date.now(), action, desc, time: new Date().toLocaleString()};
                setData(prev => ({...prev, logs: [newLog, ...prev.logs]}));
            };

            const getItemLocations = (itemId) => {
                const locs = [];
                data.rooms.forEach(r => {
                    const found = r.items.find(ri => ri.itemId === itemId);
                    if(found) locs.push({ name: r.name, qty: found.qty });
                });
                return locs;
            }
            
            const returnLoan = (loanId, returnedItems) => {
                const updatedLoans = data.loans.map(l => l.id === loanId ? { ...l, status: 'Returned', dateReturn: new Date().toISOString().split('T')[0] } : l);
                updateData('loans', updatedLoans);
                addLog("Return Loan", `Pengembalian pinjaman ID: ${loanId}`);
                syncData('SYNC_ALL', { ...data, loans: updatedLoans });
            };

            const fetchData = async () => {
                if (!scriptUrl) return;
                setLoading(true);
                try {
                    const separator = scriptUrl.includes('?') ? '&' : '?';
                    const res = await fetch(scriptUrl + separator + 'action=read');
                    const cloudData = await res.json();
                    if (cloudData) {
                        setData(prev => ({
                            ...prev,
                            items: cloudData.items || [],
                            rooms: cloudData.rooms || [],
                            loans: cloudData.loans || [],
                            logs: cloudData.logs || [],
                            maintenance: cloudData.maintenance || []
                        }));
                        if(cloudData.settings) {
                            setAppSettings({ ...INITIAL_SETTINGS, ...cloudData.settings });
                        }
                        setIsConnected(true);
                    }
                } catch (e) {
                    console.error("Fetch Error:", e);
                    setIsConnected(false);
                } finally {
                    setLoading(false);
                }
            };

            const syncData = async (type = "SYNC_ALL", overrideData = null) => {
                if (!scriptUrl) return alert("URL Script belum disetting!");
                setIsSyncing(true);
                const payload = overrideData || data;
                
                try {
                    await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: type, payload: payload, settings: appSettings })
                    });
                } catch (e) {
                    console.error("Sync Error:", e);
                    alert("Gagal sinkronisasi data.");
                } finally {
                    setIsSyncing(false);
                }
            };

            useEffect(() => { if(scriptUrl) fetchData(); }, [scriptUrl]);

            return (
                <AppContext.Provider value={{ 
                    data, updateData, getAvailableStock, addLog, getItemLocations, returnLoan, 
                    scriptUrl, setScriptUrl, loading, syncData, fetchData, isConnected, isSyncing,
                    appSettings, setAppSettings
                }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // --- UI COMPONENTS ---
        const Button = ({ children, variant="primary", className, ...props }) => {
            const variants = {
                primary: "bg-primary text-white hover:bg-indigo-700 shadow-sm shadow-indigo-200",
                secondary: "bg-white border border-slate-200 text-slate-700 hover:bg-slate-50",
                danger: "bg-red-500 text-white hover:bg-red-600 shadow-sm shadow-red-200",
                ghost: "text-slate-500 hover:bg-slate-100",
                outline: "border-2 border-slate-200 text-slate-600 hover:border-primary hover:text-primary"
            };
            return <button className={cn("px-4 py-2.5 rounded-md text-sm font-semibold transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed no-print touch-manipulation", variants[variant], className)} {...props}>{children}</button>;
        };

        const Card = ({ children, className, ...props }) => (
            <div className={cn("bg-white border border-slate-200 rounded-xl shadow-card", className)} {...props}>{children}</div>
        );
        
        const Badge = ({ children, color="slate" }) => {
            const colors = {
                slate: "bg-slate-100 text-slate-600 border-slate-200",
                green: "bg-emerald-50 text-emerald-700 border-emerald-200",
                yellow: "bg-amber-50 text-amber-700 border-amber-200",
                red: "bg-red-50 text-red-700 border-red-200",
                blue: "bg-blue-50 text-blue-700 border-blue-200",
            };
            return <span className={cn("px-2.5 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider border whitespace-nowrap", colors[color])}>{children}</span>;
        };

        const Input = (props) => <input {...props} className={cn("w-full px-3 py-2.5 rounded-md border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all placeholder:text-slate-400 bg-white", props.className)} />;
        
        const Toggle = ({ label, checked, onChange }) => (
            <div className="flex items-center justify-between py-2 border-b border-dashed border-slate-200 last:border-0">
                <span className="text-sm text-slate-600">{label}</span>
                <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name={label} id={label} checked={checked} onChange={(e) => onChange(e.target.checked)} className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/>
                    <label htmlFor={label} className={cn("toggle-label block overflow-hidden h-5 rounded-full cursor-pointer", checked ? "bg-primary" : "bg-slate-300")}></label>
                </div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-lg" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-enter no-print">
                    <div className={cn("bg-white rounded-xl shadow-2xl w-full border border-slate-200 overflow-hidden flex flex-col max-h-[90vh] m-2", maxWidth)}>
                        <div className="flex justify-between items-center p-5 border-b border-slate-100 bg-white sticky top-0 z-10">
                            <h3 className="text-lg font-bold font-sans text-slate-900">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-md text-slate-500 transition-colors modal-close-btn"><Icon name="X" size={20}/></button>
                        </div>
                        <div className="p-5 overflow-y-auto custom-scroll">{children}</div>
                    </div>
                </div>
            );
        };

        // --- LAYOUT COMPONENTS ---
        const DesktopHeader = ({ toggleSidebar }) => {
            const { isConnected, isSyncing } = useContext(AppContext);
            return (
                <header className="hidden md:flex h-16 bg-white border-b border-slate-200 items-center justify-between px-6 sticky top-0 z-20 no-print">
                    <button onClick={toggleSidebar} className="p-2 hover:bg-slate-100 rounded-md text-slate-600 transition-colors"><Icon name="Menu" size={24}/></button>
                    <div className="flex items-center gap-6">
                        <div className="flex items-center gap-2"><span className={cn("w-2.5 h-2.5 rounded-full", isSyncing ? "bg-yellow-400 animate-pulse" : isConnected ? "bg-emerald-500" : "bg-red-500")}></span><span className="text-sm font-medium text-slate-600">{isSyncing ? "Menyimpan..." : isConnected ? "Terhubung ke Database" : "Offline"}</span></div>
                        <div className="h-6 w-px bg-slate-200"></div>
                        <div className="flex items-center gap-3"><div className="text-right hidden lg:block"><p className="text-sm font-bold text-slate-800">Administrator</p><p className="text-xs text-slate-500">Satpel PVP</p></div><div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200 text-slate-500 hover:bg-slate-200 transition-colors cursor-pointer"><Icon name="User" size={20} /></div></div>
                    </div>
                </header>
            )
        }

        const Sidebar = ({ view, setView, open, setOpen, desktopOpen }) => {
            const menus = [
                { id: 'dashboard', label: 'Dashboard', icon: 'Dashboard' },
                { id: 'inventory', label: 'Data Barang', icon: 'Package' },
                { id: 'kir', label: 'KIR Ruangan', icon: 'Building' },
                { id: 'loans', label: 'Peminjaman', icon: 'ArrowLeftRight' },
                { id: 'maintenance', label: 'Maintenance', icon: 'Wrench' },
                { id: 'settings', label: 'Pengaturan', icon: 'Settings' }
            ];
            const { isConnected, isSyncing } = useContext(AppContext);
            return (
                <>
                    {open && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 md:hidden transition-opacity" onClick={() => setOpen(false)}></div>)}
                    <aside className={cn("w-64 bg-slate-900 text-white h-screen fixed left-0 top-0 z-50 flex flex-col shadow-2xl transition-transform duration-300 ease-in-out no-print", open ? "translate-x-0" : "-translate-x-full", desktopOpen ? "md:translate-x-0" : "md:-translate-x-full")}>
                        <div className="h-16 flex items-center px-6 border-b border-slate-800 shrink-0"><div className="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center mr-3 font-bold text-lg">S</div><div><h1 className="font-bold text-base leading-tight">SIBA Enterprise</h1><p className="text-slate-400 text-[10px]">Satpel PVP Jambi</p></div></div>
                        <nav className="p-4 space-y-1 flex-1 overflow-y-auto custom-scroll">{menus.map(m => (<button key={m.id} onClick={() => { setView(m.id); setOpen(false); }} className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md text-sm font-medium transition-all duration-200", view === m.id || view.startsWith(m.id) ? "bg-indigo-600 text-white shadow-lg shadow-indigo-900/20" : "text-slate-400 hover:bg-slate-800 hover:text-white")}><Icon name={m.icon} size={20}/> <span>{m.label}</span></button>))}</nav>
                        <div className="p-4 border-t border-slate-800 bg-slate-900 shrink-0"><div className="flex items-center justify-between text-xs mb-1"><span className="text-slate-500">Status System</span><div className="flex items-center gap-2"><span className={cn("w-2 h-2 rounded-full", isSyncing ? "bg-yellow-400 animate-pulse" : isConnected ? "bg-green-500" : "bg-red-500")}></span><span className="text-slate-400">{isSyncing ? "Syncing..." : isConnected ? "Online" : "Offline"}</span></div></div></div>
                    </aside>
                </>
            );
        };

        // --- CHARTS & TABLES ---
        const SimpleBarChart = ({ data }) => {
            const max = Math.max(...data.map(d => d.value)) || 1;
            return (
                <div className="w-full pt-4">
                    <div className="flex items-end justify-between gap-2 min-h-[160px]">
                        {data.map((d, i) => (
                            <div key={i} className="flex flex-col items-center gap-2 flex-1 min-w-[20px]">
                                <div className="w-full bg-slate-100 rounded-t-lg relative overflow-hidden flex items-end min-h-[140px]">
                                    <div
                                        className="w-full bg-gradient-to-t from-indigo-500 to-indigo-400 transition-all duration-700 ease-out rounded-t-lg"
                                        style={{ height: `${(d.value / max) * 100}%` }}
                                    ></div>
                                </div>
                                <span className="text-[10px] font-bold text-slate-500 uppercase truncate max-w-full">{d.label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SmartTable = ({ data = [], columns, onRowClick, actions, filterDefs = [], renderMobileItem }) => {
            const [search, setSearch] = useState("");
            const [activeFilters, setActiveFilters] = useState({});
            const [page, setPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10); 

            useEffect(() => {
                const initialFilters = {};
                filterDefs.forEach(def => initialFilters[def.key] = def.options[0].value);
                setActiveFilters(initialFilters);
            }, [filterDefs]);

            const handleFilterChange = (key, value) => { setActiveFilters(prev => ({ ...prev, [key]: value })); setPage(1); };
            
            const safeData = Array.isArray(data) ? data : [];
            const filteredData = safeData.filter(item => {
                const matchesSearch = Object.values(item).some(val => String(val || "").toLowerCase().includes(search.toLowerCase()));
                let matchesFilters = true;
                for (const def of filterDefs) {
                    const selectedValue = activeFilters[def.key];
                    const optionDef = def.options.find(opt => opt.value === selectedValue);
                    if (optionDef && optionDef.fn) { if (!optionDef.fn(item)) { matchesFilters = false; break; } }
                }
                return matchesSearch && matchesFilters;
            });
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const paginatedData = filteredData.slice((page - 1) * itemsPerPage, page * itemsPerPage);

            return (
                <div className="flex flex-col gap-4">
                    <Card className="flex flex-col overflow-hidden bg-white">
                        <div className="p-4 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between bg-white no-print">
                            <div className="relative flex-1 w-full md:max-w-md"><Icon name="Search" className="absolute left-3 top-3 text-slate-400" size={18}/><Input placeholder="Cari data..." className="pl-10 h-10 bg-slate-50 border-slate-200 focus:bg-white focus:border-primary w-full shadow-sm text-sm" value={search} onChange={e => { setSearch(e.target.value); setPage(1); }} /></div>
                            <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                                {filterDefs.map(def => (<div key={def.key} className="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2"><label className="text-[10px] font-bold text-slate-500 uppercase sm:hidden md:block">{def.label}:</label><div className="relative"><select className="appearance-none h-10 sm:h-7 w-full sm:w-28 pl-2 pr-6 rounded-lg border border-slate-200 bg-white text-xs sm:text-[10px] font-medium text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all cursor-pointer py-1 small-text" value={activeFilters[def.key] || 'all'} onChange={e => handleFilterChange(def.key, e.target.value)}>{def.options.map(opt => (<option key={opt.value} value={opt.value}>{opt.label}</option>))}</select><Icon name="ChevronDown" className="absolute right-2 top-3 sm:top-2 text-slate-400 pointer-events-none" size={12}/></div></div>))}
                                {actions}
                            </div>
                        </div>
                        <div className="hidden print-only p-4 border-b"><h2 className="text-lg font-bold">Laporan Data</h2><p className="text-xs">Pencarian: {search || "-"}</p>{Object.entries(activeFilters).map(([k, v]) => (<span key={k} className="text-xs mr-4 capitalize">{k}: {v}</span>))}</div>
                        {renderMobileItem && (<div className="md:hidden p-4 space-y-4 bg-slate-50">{paginatedData.map((row, idx) => (<div key={idx} onClick={() => onRowClick && onRowClick(row)}>{renderMobileItem(row)}</div>))}{paginatedData.length === 0 && <div className="text-center p-8 text-slate-400 bg-white rounded-xl border border-dashed">Tidak ada data ditemukan.</div>}</div>)}
                        <div className={cn("overflow-x-auto custom-scroll hidden", renderMobileItem ? "md:block" : "block")}><table className="w-full text-left text-sm min-w-full"><thead className="bg-slate-50 text-slate-600 border-b border-slate-200 font-semibold uppercase text-[11px] tracking-wider whitespace-nowrap"><tr>{columns.map((col, idx) => <th key={idx} className={cn("px-4 py-3 md:px-6 md:py-4", col.className)}>{col.header}</th>)}</tr></thead><tbody className="divide-y divide-slate-100 bg-white">{paginatedData.map((row, idx) => (<tr key={idx} onClick={() => onRowClick && onRowClick(row)} className={cn("hover:bg-slate-50 transition-colors group", onRowClick && "cursor-pointer")}>{columns.map((col, cIdx) => (<td key={cIdx} className={cn("px-4 py-3 md:px-6 md:py-3.5 text-sm align-top whitespace-nowrap", col.className)}>{col.render ? col.render(row) : (typeof col.accessor === 'function' ? col.accessor(row) : row[col.accessor])}</td>))}</tr>))}{paginatedData.length === 0 && <tr><td colSpan={columns.length} className="p-8 text-center text-slate-400 italic py-12">Tidak ada data ditemukan.</td></tr>}</tbody></table></div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 no-print">
                            <div className="flex items-center gap-3"><span className="text-[10px] font-bold text-slate-500 uppercase">Tampilkan</span><div className="relative"><select className="appearance-none h-7 pl-2 pr-6 rounded-lg border border-slate-200 bg-white text-[10px] font-medium text-slate-700 focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none cursor-pointer py-1 small-text" value={itemsPerPage} onChange={e => { setItemsPerPage(Number(e.target.value)); setPage(1); }}><option value={10}>10</option><option value={30}>30</option><option value={50}>50</option><option value={100}>100</option></select><Icon name="ChevronDown" className="absolute right-2 top-2 text-slate-400 pointer-events-none" size={12}/></div><span className="text-[10px] font-bold text-slate-500 uppercase">data. Hal {page} dari {totalPages || 1}</span></div>
                            {totalPages > 1 && (<div className="flex justify-center gap-2"><Button variant="outline" size="sm" onClick={() => setPage(Math.max(1, page - 1))} disabled={page === 1}><Icon name="ChevronLeft" size={16}/></Button><Button variant="outline" size="sm" onClick={() => setPage(Math.min(totalPages, page + 1))} disabled={page === totalPages}><Icon name="ChevronRight" size={16}/></Button></div>)}
                        </div>
                    </Card>
                </div>
            );
        };

        // --- DASHBOARD ---
        const Dashboard = () => {
            const { data } = useContext(AppContext);
            const safeItems = data.items || [];
            const safeLoans = data.loans || [];
            const safeMaint = data.maintenance || [];
            const totalAssets = safeItems.reduce((a,b) => a + ((b.price || 0) * (b.stock || 0)), 0);
            const activeLoans = safeLoans.filter(l => l.status === 'Active').length;
            const maintenanceCount = safeMaint.filter(m => m.status !== 'Done').length;
            const totalItems = safeItems.length;
            const stats = [{ label: "Total Aset", val: formatCurrency(totalAssets), icon: "Package", bg: "bg-white", text: "text-slate-800" }, { label: "Jenis Barang", val: totalItems, icon: "Package", bg: "bg-white", text: "text-slate-800" }, { label: "Sedang Dipinjam", val: activeLoans, icon: "ArrowLeftRight", bg: "bg-white", text: "text-slate-800" }, { label: "Perlu Perbaikan", val: maintenanceCount, icon: "Wrench", bg: "bg-white", text: "text-slate-800" }];
            return (
                <div className="space-y-6 sm:space-y-8 animate-enter">
                    <h2 className="text-xl sm:text-2xl font-bold text-slate-800">Dashboard Overview</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">{stats.map((s, i) => (<Card key={i} className={cn("p-5 transition-transform hover:scale-[1.02]", s.bg === "bg-white" ? "bg-white border border-slate-200" : s.bg)}><div className="flex justify-between items-start mb-3"><div className={cn("p-3 rounded-md", i===0 ? "bg-indigo-500 text-white" : "bg-slate-100 text-primary")}><Icon name={s.icon} size={20}/></div></div><h3 className={cn("text-2xl font-black", s.text)}>{s.val}</h3><p className={cn("text-sm opacity-80 font-medium", s.text)}>{s.label}</p></Card>))}</div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><Card className="p-6"><h3 className="font-bold text-lg mb-4 text-slate-800">Statistik Peminjaman</h3><SimpleBarChart data={[{label:'Jan',value:40},{label:'Feb',value:65},{label:'Mar',value:80},{label:'Apr',value:50},{label:'Mei',value:90},{label:'Jun',value:30}]} /></Card><Card className="p-6"><h3 className="font-bold text-lg mb-4 text-slate-800">Aktivitas Terbaru</h3><div className="space-y-4">{data.logs.slice(0,5).map((l,i) => (<div key={i} className="pb-3 border-b border-slate-100 last:border-0 last:pb-0"><p className="text-sm font-bold text-slate-800">{l.action}</p><p className="text-xs text-slate-500">{l.desc}</p><span className="text-[10px] text-slate-400">{l.time}</span></div>))}{data.logs.length === 0 && <p className="text-sm text-slate-400 italic">Belum ada aktivitas.</p>}</div></Card></div>
                </div>
            );
        };

        // --- NEW COMPONENT: InventoryCreate (Page) ---
        const InventoryCreate = ({ onBack, initialData = null }) => {
            const { data, updateData, addLog, syncData } = useContext(AppContext);
            const [form, setForm] = useState(initialData || { unit: 'Unit', year: new Date().getFullYear(), qty: 0 });

            const handleSave = () => {
                if (!form.name || !form.code || (form.qty === undefined || form.qty === null)) {
                    alert("Harap lengkapi nama barang, kode barang, dan jumlah!");
                    return;
                }

                let updatedItems;
                if (initialData) {
                    // Update Logic
                    updatedItems = data.items.map(item => item.id === form.id ? form : item);
                    addLog("Update Item", `Memperbarui ${form.name}`);
                } else {
                    // Create Logic
                    const newItem = {
                        ...form,
                        id: Date.now(),
                        stock: parseInt(form.qty || 0),
                        condGood: parseInt(form.qty || 0),
                        condBad: 0,
                        status: "Tersedia",
                        locs: [],
                        price: parseInt(form.price || 0)
                    };
                    updatedItems = [newItem, ...data.items];
                    addLog("Create Item", `Menambahkan ${newItem.name}`);
                }

                updateData('items', updatedItems);
                syncData('SYNC_ALL', { ...data, items: updatedItems });
                alert(initialData ? "Data barang berhasil diperbarui!" : "Data barang berhasil disimpan!");
                onBack();
            };

            return (
                <div className="space-y-6 animate-enter pb-10">
                    <div className="flex items-center gap-4">
                        <Button variant="outline" className="px-3" onClick={onBack}><Icon name="ArrowLeft" size={18}/></Button>
                        <h2 className="text-2xl font-bold text-slate-900">{initialData ? 'Edit Data Barang' : 'Tambah Barang Baru'}</h2>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-6">
                            <Card className="p-6">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 border-b pb-2">Informasi Dasar</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Barang <span className="text-red-500">*</span></label><Input placeholder="Contoh: Laptop Asus ROG" value={form.name || ''} onChange={e => setForm({...form, name: e.target.value})} /></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kode Barang <span className="text-red-500">*</span></label><Input placeholder="LP-001" value={form.code || ''} onChange={e => setForm({...form, code: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kategori</label><Input placeholder="Elektronik" value={form.category || ''} onChange={e => setForm({...form, category: e.target.value})} /></div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Merk (Brand)</label><Input placeholder="Samsung" value={form.brand || ''} onChange={e => setForm({...form, brand: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Model / Tipe</label><Input placeholder="Galaxy S23" value={form.model || ''} onChange={e => setForm({...form, model: e.target.value})} /></div>
                                    </div>
                                </div>
                            </Card>
                            
                            <Card className="p-6">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 border-b pb-2">Inventaris & Harga</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Jumlah Awal <span className="text-red-500">*</span></label>
                                        <Input type="number" placeholder="0" value={form.qty} onChange={e => setForm({...form, qty: parseInt(e.target.value) || 0})} />
                                        {!initialData && <p className="text-[10px] text-slate-400 mt-1">Otomatis masuk kondisi 'Baik'</p>}
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Satuan</label>
                                        <select className="w-full px-3 py-2.5 rounded-md border border-slate-200 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" value={form.unit || 'Unit'} onChange={e => setForm({...form, unit: e.target.value})}>
                                            {UNIT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Tahun Perolehan</label>
                                        <Input type="number" placeholder="2023" value={form.year} onChange={e => setForm({...form, year: e.target.value})} />
                                    </div>
                                </div>
                                <div className="mt-4">
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Harga Satuan (Rp)</label>
                                    <Input type="number" placeholder="Rp 0" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
                                </div>
                                {initialData && (
                                    <div className="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-slate-100">
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kondisi Baik</label><Input type="number" value={form.condGood || 0} onChange={e => setForm({...form, condGood: parseInt(e.target.value) || 0})} /></div>
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kondisi Rusak</label><Input type="number" value={form.condBad || 0} onChange={e => setForm({...form, condBad: parseInt(e.target.value) || 0})} /></div>
                                    </div>
                                )}
                            </Card>
                        </div>
                        
                        <div className="lg:col-span-1 space-y-6">
                             <Card className="p-6 bg-slate-50 border-slate-200">
                                <h3 className="font-bold text-lg mb-4 text-slate-800">Aksi</h3>
                                <p className="text-sm text-slate-600 mb-4">Pastikan data yang Anda masukkan sudah benar sebelum menyimpan.</p>
                                <Button className="w-full h-12 text-lg shadow-lg mb-3" onClick={handleSave}><Icon name="Save" /> {initialData ? 'Simpan Perubahan' : 'Simpan Barang'}</Button>
                                <Button variant="secondary" className="w-full" onClick={onBack}>Batal</Button>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW COMPONENT: RoomCreate (Page) ---
        const RoomCreate = ({ onBack, initialData = null }) => {
             const { data, updateData, syncData } = useContext(AppContext);
             const [form, setForm] = useState(initialData || {});

             const handleSave = () => {
                if (!form.name) { alert("Nama ruangan wajib diisi!"); return; }
                
                let newRooms;
                if (initialData) {
                    // Update existing room
                    newRooms = data.rooms.map(r => r.id === form.id ? { ...r, ...form } : r);
                } else {
                    // Create new room
                    newRooms = [...data.rooms, { ...form, id: Date.now(), items: [] }];
                }
                
                updateData('rooms', newRooms);
                syncData('SYNC_ALL', { ...data, rooms: newRooms });
                alert(initialData ? "Ruangan berhasil diperbarui!" : "Ruangan berhasil dibuat!");
                onBack();
             };

             return (
                <div className="space-y-6 animate-enter pb-10">
                    <div className="flex items-center gap-4">
                        <Button variant="outline" className="px-3" onClick={onBack}><Icon name="ArrowLeft" size={18}/></Button>
                        <h2 className="text-2xl font-bold text-slate-900">{initialData ? 'Edit Ruangan' : 'Buat Ruangan Baru'}</h2>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-6">
                            <Card className="p-6">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 border-b pb-2">Identitas Ruangan</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Ruangan <span className="text-red-500">*</span></label><Input placeholder="Contoh: Lab Komputer 1" value={form.name || ''} onChange={e => setForm({...form, name: e.target.value})} /></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kode Ruangan</label><Input placeholder="R-001" value={form.code || ''} onChange={e => setForm({...form, code: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Penanggung Jawab (PIC)</label><Input placeholder="Nama Guru/Staff" value={form.pic || ''} onChange={e => setForm({...form, pic: e.target.value})} /></div>
                                    </div>
                                </div>
                            </Card>
                            <Card className="p-6">
                                <h3 className="font-bold text-lg mb-4 text-slate-800 border-b pb-2">Departemen</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kejuruan</label><Input placeholder="TJKT" value={form.department || ''} onChange={e => setForm({...form, department: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Sub Kejuruan</label><Input placeholder="Teknik Jaringan" value={form.subDepartment || ''} onChange={e => setForm({...form, subDepartment: e.target.value})} /></div>
                                </div>
                            </Card>
                        </div>
                        <div className="lg:col-span-1 space-y-6">
                             <Card className="p-6 bg-slate-50 border-slate-200">
                                <h3 className="font-bold text-lg mb-4 text-slate-800">Aksi</h3>
                                <Button className="w-full h-12 text-lg shadow-lg mb-3" onClick={handleSave}><Icon name="Save" /> {initialData ? 'Simpan Perubahan' : 'Simpan Ruangan'}</Button>
                                <Button variant="secondary" className="w-full" onClick={onBack}>Batal</Button>
                            </Card>
                        </div>
                    </div>
                </div>
             );
        };

        // --- INVENTORY ---
        const Inventory = ({ setView, setDetailItem }) => {
            const { data, updateData, addLog, getItemLocations, syncData } = useContext(AppContext);
            const [showImportModal, setShowImportModal] = useState(false);
            const [importData, setImportData] = useState([]);
            const fileInputRef = useRef(null);

            const handleFileUpload = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        setImportData(jsonData.map((row, index) => ({ name: row['Nama Barang'] || row['Nama'] || '', brand: row['Merk'] || row['Brand'] || '', model: row['Tipe/Model (Uraian)'] || row['Tipe'] || row['Model'] || '', category: row['Kategori'] || '', year: row['Tahun'] || '', qty: parseInt(row['Jumlah'] || 0), unit: row['Satuan'] || 'Unit', price: parseInt(row['Nominal (Rp)'] || row['Nominal'] || row['Harga'] || 0), code: `BRG-${Math.floor(Date.now()/1000)}-${index}` })));
                    } catch (err) { alert("Gagal membaca file excel. Pastikan format benar."); }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleImportSave = () => {
                if (importData.length === 0) return alert("Tidak ada data!");
                const newItems = importData.map(item => ({ ...item, id: Date.now() + Math.floor(Math.random() * 10000), stock: parseInt(item.qty || 0), condGood: parseInt(item.qty || 0), condBad: 0, status: "Tersedia", locs: [] }));
                const updatedItems = [...newItems, ...data.items]; updateData('items', updatedItems); syncData('SYNC_ALL', { ...data, items: updatedItems }); setShowImportModal(false); setImportData([]);
            };

            const downloadSampleTemplate = () => {
                const ws = XLSX.utils.json_to_sheet([{ "Nama Barang": "Contoh Barang", "Kode Barang": "B001", "Model": "Tipe X", "Tahun": "2024", "Harga": "50000", "Jumlah": "10" }]);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, "template_barang.xlsx");
            };

            const columns = [
                { header: "No", render: (r) => data.items.indexOf(r) + 1, className: "w-10 text-center align-top text-slate-500" },
                { header: "Informasi Barang", render: r => (<div className="whitespace-nowrap"><p className="font-semibold text-slate-800 text-[13px]">{r.name}</p><span className="inline-block mt-0.5 px-1.5 py-px rounded-sm text-[10px] font-mono font-medium bg-slate-100 text-slate-500 border border-slate-100 leading-tight">{r.code}</span></div>), className: "min-w-[180px] align-top" },
                { header: "Merk / Model", render: r => (<div className="whitespace-nowrap"><p className="font-medium text-slate-700 text-[13px]">{r.brand || '-'}</p><p className="text-[11px] text-slate-500 mt-0.5">{r.model || '-'}</p></div>), className: "min-w-[120px] align-top" },
                { header: "Total Stok", render: r => (<div className="text-center"><span className="font-semibold text-slate-700">{r.stock} <span className="text-[10px] font-normal text-slate-500">{r.unit || 'Unit'}</span></span></div>), className: "text-center w-24 align-top" },
                { header: "Tahun", render: r => (<div className="text-center"><span className="text-[13px] text-slate-600">{r.year || '-'}</span></div>), className: "text-center w-16 align-top" },
                { header: "Lokasi", render: r => { const locs = getItemLocations(r.id); return locs.length > 0 ? (<div className="flex flex-wrap gap-1">{locs.map((l, i) => (<span key={i} className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded-md border border-indigo-100 whitespace-nowrap font-medium">{l.name} <span className="font-bold">({l.qty})</span></span>))}</div>) : <span className="text-[11px] text-slate-400 italic">-</span> }, className: "min-w-[160px] align-top" },
                { header: "Kondisi", render: r => (<div className="text-[11px] font-medium whitespace-nowrap flex flex-col gap-1"><span className="text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded-md border border-emerald-100 w-fit">{r.condGood || 0} Baik</span><span className="text-red-700 bg-red-50 px-2 py-0.5 rounded-md border border-red-100 w-fit">{r.condBad || 0} Rusak</span></div>), className: "align-top" },
                { header: "Status", render: r => <Badge color={r.stock > 0 ? 'green' : 'red'}>{r.stock > 0 ? 'Tersedia' : 'Habis'}</Badge>, className: "w-24 align-top" },
                { header: "Aksi", render: r => (<div className="flex gap-2 justify-center items-center"><button className="h-8 w-8 p-0 border border-indigo-200 text-indigo-600 hover:bg-indigo-50 hover:text-indigo-800 shadow-sm transition-colors flex items-center justify-center bg-white rounded-md" title="Detail" onClick={() => { setDetailItem(r); setView('inventory-detail'); }}><Icon name="Eye" size={16}/></button><button className="h-8 w-8 p-0 border border-red-200 text-red-600 hover:bg-red-50 hover:text-red-800 shadow-sm transition-colors flex items-center justify-center bg-white rounded-md" title="Hapus" onClick={(e) => { e.stopPropagation(); if(confirm("Hapus barang?")) { const updated = data.items.filter(i => i.id !== r.id); updateData('items', updated); syncData('SYNC_ALL', { ...data, items: updated }); } }}><Icon name="Trash" size={16}/></button></div>), className: "w-24 text-center align-top no-print" }
            ];

            const renderMobileItem = (r) => {
                const locs = getItemLocations(r.id);
                return (
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 active:scale-[0.99] transition-transform">
                        <div className="flex justify-between items-start mb-3"><div><h3 className="font-semibold text-slate-900 text-base leading-tight">{r.name}</h3><span className="inline-block mt-0.5 px-1.5 py-px rounded-sm text-[10px] font-mono font-medium bg-slate-100 text-slate-500 border border-slate-100 leading-tight">{r.code}</span></div><div className="flex flex-col items-end gap-1"><Badge color={r.stock > 0 ? 'green' : 'red'}>{r.stock > 0 ? 'Tersedia' : 'Habis'}</Badge><span className="text-[11px] font-medium text-slate-500">Stok: <span className="font-bold text-slate-800">{r.stock} {r.unit || 'Unit'}</span></span></div></div>
                        <div className="grid grid-cols-2 gap-3 text-sm mb-4"><div className="bg-slate-50 p-2 rounded-md"><span className="text-[10px] text-slate-500 uppercase font-semibold block mb-1">Merk / Model</span><span className="text-slate-700 font-medium block truncate text-[13px]">{r.brand || '-'}/{r.model || '-'}</span></div><div className="bg-slate-50 p-2 rounded-md"><span className="text-[10px] text-slate-500 uppercase font-semibold block mb-1">Kondisi</span><div className="text-[11px] flex flex-col gap-0.5"><span className="text-emerald-700 font-medium">{r.condGood} Baik</span><span className="text-red-700 font-medium">{r.condBad} Rusak</span></div></div></div>
                        <div className="mb-4"><span className="text-[10px] text-slate-500 uppercase font-semibold block mb-1">Lokasi Penyimpanan</span>{locs.length > 0 ? (<div className="flex flex-wrap gap-1">{locs.map((l, i) => (<span key={i} className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md border border-indigo-100 font-medium">{l.name} <span className="font-bold">({l.qty})</span></span>))}</div>) : <span className="text-xs text-slate-400 italic">Belum ada lokasi</span>}</div>
                        <div className="flex gap-2 border-t pt-3"><Button size="sm" variant="outline" className="flex-1 border-slate-300 text-slate-700 hover:bg-slate-50" onClick={() => { setDetailItem(r); setView('inventory-detail'); }}><Icon name="Eye" size={16}/> Detail</Button><Button size="sm" variant="danger" className="w-12 px-0 bg-white border border-red-200 text-red-500 hover:bg-red-50" onClick={(e) => { e.stopPropagation(); if(confirm("Hapus barang?")) { const updated = data.items.filter(i => i.id !== r.id); updateData('items', updated); syncData('SYNC_ALL', { ...data, items: updated }); } }}><Icon name="Trash" size={16}/></Button></div>
                    </div>
                );
            };

            const filterDefs = [{ key: 'status', label: 'Status', options: [{ label: 'Semua Status', value: 'all', fn: () => true }, { label: 'Tersedia', value: 'available', fn: i => (i.stock || 0) > 0 }, { label: 'Habis', value: 'out', fn: i => (i.stock || 0) <= 0 }] }, { key: 'condition', label: 'Kondisi', options: [{ label: 'Semua Kondisi', value: 'all', fn: () => true }, { label: 'Ada Rusak', value: 'damaged', fn: i => (i.condBad || 0) > 0 }, { label: '100% Baik', value: 'perfect', fn: i => (i.condBad || 0) === 0 && (i.condGood || 0) > 0 }] }];

            return (
                <div className="space-y-6 animate-enter">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 no-print"><div><h2 className="text-2xl font-bold text-slate-800">Data Barang</h2><p className="text-slate-500 text-sm mt-1">{data.items.length} jenis barang terdaftar</p></div><div className="flex gap-2 w-full sm:w-auto"><Button variant="outline" onClick={() => window.print()} className="flex-1 sm:flex-none"><Icon name="Printer" size={16} /> Cetak</Button><Button variant="outline" onClick={() => setShowImportModal(true)} className="flex-1 sm:flex-none"><Icon name="Upload" size={16} /> Import</Button><Button onClick={() => setView('inventory-create')} className="flex-1 sm:flex-none"><Icon name="Plus" size={16} /> Tambah</Button></div></div>
                    <SmartTable data={data.items} columns={columns} filterDefs={filterDefs} renderMobileItem={renderMobileItem} />
                    <Modal isOpen={showImportModal} onClose={() => setShowImportModal(false)} title="Import Excel">
                        <div className="space-y-4">
                            <div className="flex justify-between items-center bg-slate-50 p-3 rounded"><span className="text-sm">Download template excel</span><Button size="sm" variant="outline" onClick={downloadSampleTemplate}>Download</Button></div>
                            <div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Upload File</label><input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx, .xls" className="w-full text-sm p-2 border rounded" /></div>
                            {importData.length > 0 && <div className="text-sm text-green-600 bg-green-50 p-2 rounded">{importData.length} data siap diimport.</div>}
                            <Button className="w-full mt-4" onClick={handleImportSave} disabled={importData.length === 0}>Import Sekarang</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const InventoryDetail = ({ item, onBack, setView }) => {
            const { getItemLocations, updateData, data, syncData, addLog } = useContext(AppContext);
            const [tab, setTab] = useState('info');

            if(!item) return null;
            const locs = getItemLocations(item.id);

            useEffect(() => { 
                setTimeout(() => { 
                    const canvas = document.getElementById('item-qr-details'); 
                    if (canvas) new QRious({ element: canvas, value: `${window.location.origin}${window.location.pathname}#item-${item.id}`, size: 128 }); 
                }, 100); 
            }, [item, tab]);

            return (
                <div className="space-y-6 animate-enter">
                    <div className="flex items-center justify-between gap-4"><div className="flex items-center gap-4"><Button variant="outline" className="px-3" onClick={onBack}><Icon name="ArrowLeft" size={18}/></Button><div><h2 className="text-xl sm:text-2xl font-bold text-slate-900 leading-tight">{item.name}</h2><p className="text-slate-500 font-mono text-sm">{item.code}</p></div></div><Button variant="secondary" className="border-indigo-200 text-indigo-700 bg-indigo-50 hover:bg-indigo-100" onClick={() => setView('inventory-edit')}><Icon name="Edit" size={16}/> <span className="hidden sm:inline">Edit Barang</span></Button></div>
                    <div className="flex gap-4 border-b border-slate-200 overflow-x-auto">{['info', 'history', 'docs'].map(t => (<button key={t} onClick={()=>setTab(t)} className={cn("pb-3 px-2 font-bold border-b-2 capitalize transition-all whitespace-nowrap", tab===t ? "border-primary text-primary" : "border-transparent text-slate-500")}>{t === 'info' ? 'Ringkasan' : t === 'history' ? 'Riwayat' : 'Dokumentasi'}</button>))}</div>
                    {tab === 'info' && (<div className="grid grid-cols-1 md:grid-cols-3 gap-6"><Card className="p-6 space-y-4"><h3 className="font-bold border-b pb-2">Spesifikasi</h3><div className="grid grid-cols-2 gap-y-4 gap-x-2 text-sm"><div><p className="text-xs text-slate-400 font-bold uppercase">Kode</p><p>{item.code}</p></div><div><p className="text-xs text-slate-400 font-bold uppercase">Tahun</p><p>{item.year || '-'}</p></div><div className="col-span-2"><p className="text-xs text-slate-400 font-bold uppercase">Model</p><p>{item.model || "-"}</p></div><div className="col-span-2"><p className="text-xs text-slate-400 font-bold uppercase">Harga</p><p>{formatCurrency(item.price || 0)}</p></div></div><div className="pt-4 border-t flex flex-col items-center"><canvas id="item-qr-details" className="bg-white p-2 border rounded"></canvas><p className="text-xs text-slate-400 mt-1">Scan untuk detail</p></div></Card><Card className="md:col-span-2 p-6"><h3 className="font-bold border-b pb-2 mb-4">Sebaran Lokasi</h3>{locs.length > 0 ? (<div className="space-y-2">{locs.map((l, i) => (<div key={i} className="flex justify-between p-3 border rounded-lg items-center"><span className="font-medium text-sm sm:text-base">{l.name}</span><Badge variant="primary">{l.qty} Unit</Badge></div>))}</div>) : <p className="text-slate-400 italic text-sm">Belum ditempatkan di ruangan manapun.</p>}</Card></div>)}
                    {tab === 'history' && (<Card className="p-6"><h3 className="font-bold mb-4">Riwayat Pergerakan</h3><div className="space-y-3">{item.logs && item.logs.map((l,i)=>(<div key={i} className="flex flex-col sm:flex-row gap-1 sm:gap-4 border-b pb-2"><span className="text-xs font-mono text-slate-500 min-w-[140px]">{l.date}</span><span className="text-sm">{l.action}</span></div>))}</div></Card>)}
                </div>
            );
        };

        const PrintLabelView = ({ room, items, onBack }) => {
            const { appSettings } = useContext(AppContext);
            const [showLogo, setShowLogo] = useState(true);
            const [showQr, setShowQr] = useState(true);
            const [showBorder, setShowBorder] = useState(true);
            const [showAgency, setShowAgency] = useState(true);
            const [showPageHeader, setShowPageHeader] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            
            useEffect(() => {
                setTimeout(() => {
                    items.forEach((item, idx) => {
                        const el = document.getElementById(`lbl-qr-${idx}`);
                        if(el && showQr) new QRious({ element: el, value: `${window.location.origin}${window.location.pathname}#item-${item.id}`, size: 150 });
                    });
                }, 500);
            }, [items, showQr]);

            const exportLabelsToWord = () => {
                setIsGenerating(true);
                let html = '<table style="width: 100%; border-collapse: collapse; table-layout: fixed;">';
                const columns = 4;
                const itemsWithQr = items.map((item, i) => {
                    const canvas = document.getElementById(`lbl-qr-${i}`);
                    const qrData = canvas ? canvas.toDataURL('image/png') : ''; 
                    return { ...item, qrData };
                });

                for (let i = 0; i < itemsWithQr.length; i++) {
                    if (i % columns === 0) html += '<tr>';
                    const item = itemsWithQr[i];
                    const borderStyle = showBorder ? 'border: 1px solid #000;' : 'border: 1px dashed #ccc;';
                    html += `
                        <td style="padding: 5px; vertical-align: top; width: 25%;">
                            <div style="${borderStyle} padding: 5px; font-family: 'Times New Roman', serif; height: 140px;">
                                ${showAgency ? `<div style="border-bottom: 2px solid #000; padding-bottom: 2px; margin-bottom: 3px; display: flex; align-items: center;"><table style="width:100%"><tr>${showLogo ? `<td style="width:30px;"><img src="${appSettings.logoUrl}" width="30" height="30" /></td>` : ''}<td style="text-align:center;"><span style="font-size: 8px; font-weight: 900; display:block; text-transform:uppercase;">BMN KEMENTERIAN<br/>KETENAGAKERJAAN RI</span><span style="font-size: 7px; font-weight: bold; display:block; text-transform:uppercase;">SATPEL PVP JAMBI</span></td></tr></table></div>` : ''}
                                <table style="width:100%; font-family: 'Arial', sans-serif;"><tr><td style="vertical-align:top;"><div style="font-size: 8px; color: #555; font-weight:bold;">KODE BARANG</div><div style="background:#eee; border:1px solid #ccc; font-family:monospace; font-size:10px; font-weight:bold; text-align:center; padding:2px;">${item.code}</div><div style="font-size: 8px; color: #555; font-weight:bold; margin-top:2px;">NAMA BARANG</div><div style="font-size: 10px; font-weight:bold; line-height:1.1; height:22px; overflow:hidden;">${item.name}</div><table style="width:100%; border-top:1px solid #ccc; margin-top:2px; padding-top:2px;"><tr><td><span style="font-size:8px; color:#555; font-weight:bold; display:block;">MERK/TIPE</span><span style="font-size:9px;">${item.brand} ${item.model}</span></td><td style="text-align:right;"><span style="font-size:8px; color:#555; font-weight:bold; display:block;">THN</span><span style="font-size:9px; font-weight:bold;">${item.year||'-'}</span></td></tr></table></td>${showQr ? `<td style="width:50px; vertical-align:middle; text-align:center; padding-left:4px; border-left:1px dotted #ccc;"><img src="${item.qrData}" width="48" height="48" /></td>` : ''}</tr></table>
                            </div>
                        </td>
                    `;
                    if (i % columns === columns - 1) html += '</tr>';
                }
                html += '</table>';
                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Labels</title><style>@page { size: 21cm 29.7cm; margin: 0.5cm; }</style></head><body>`;
                const footer = `</body></html>`;
                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + html + footer);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `Label_BMN_${new Date().getTime()}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
                setIsGenerating(false);
            };

            const downloadPDF = async () => {
                 setIsGenerating(true);
                 const element = document.getElementById("print-area");
                 if (!element) return;
                 element.classList.add('pdf-capture-mode');
                 try {
                     const canvas = await html2canvas(element, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' });
                     const imgData = canvas.toDataURL('image/jpeg', 0.95);
                     const { jsPDF } = window.jspdf;
                     const pdf = new jsPDF('p', 'mm', 'a4');
                     const imgWidth = 210; 
                     const pageHeight = 297; 
                     const imgHeight = canvas.height * imgWidth / canvas.width;
                     let heightLeft = imgHeight;
                     let position = 0;
                     pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                     heightLeft -= pageHeight;
                     while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                     }
                     pdf.save(`Label_BMN_${new Date().getTime()}.pdf`);
                 } catch (e) {
                     alert("Gagal membuat PDF. Coba gunakan fitur Print -> Save as PDF.");
                 } finally {
                     element.classList.remove('pdf-capture-mode');
                     setIsGenerating(false);
                 }
            };

            return (
                <div className="space-y-6 animate-enter min-h-screen">
                    <div className="flex items-center gap-4 no-print">
                        <Button variant="outline" className="px-3" onClick={onBack}><Icon name="ArrowLeft" size={18}/></Button>
                        <div>
                            <h2 className="text-xl sm:text-2xl font-bold text-slate-900 leading-tight">Cetak Label Barang - {room ? room.name : 'Semua Ruangan'}</h2>
                            <p className="text-slate-500 font-mono text-sm">{items.length} item siap dicetak</p>
                        </div>
                    </div>
                    <div className="flex flex-col md:flex-row gap-6 items-start">
                        <div className="w-full md:w-80 flex-shrink-0 print-controls space-y-4 no-print sticky top-6">
                            <div className="bg-white p-6 rounded-xl shadow-soft border border-slate-200">
                                <div className="flex items-center gap-3 mb-6 text-slate-800 border-b pb-4">
                                    <div className="p-2 bg-indigo-50 text-primary rounded-lg"><Icon name="Settings" size={20} /></div>
                                    <div><h3 className="font-bold text-lg leading-tight">Pengaturan</h3><p className="text-xs text-slate-500">Kustomisasi Label</p></div>
                                </div>
                                <div className="bg-indigo-50/50 p-3 rounded-lg border border-indigo-100 mb-6">
                                    <div className="flex justify-between items-center text-sm mb-1"><span className="text-slate-500">Total Label:</span><span className="font-bold text-indigo-700">{items.length} Pcs</span></div>
                                    <div className="flex justify-between items-center text-sm"><span className="text-slate-500">Kertas:</span><span className="font-bold text-slate-700">A4 (Portrait)</span></div>
                                </div>
                                <div className="space-y-4 mb-8">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Tampilan Kartu</h4>
                                    <div className="space-y-2">
                                        <Toggle label="Logo Instansi" checked={showLogo} onChange={setShowLogo} />
                                        <Toggle label="QR Code" checked={showQr} onChange={setShowQr} />
                                        <Toggle label="Garis Tepi (Border)" checked={showBorder} onChange={setShowBorder} />
                                        <Toggle label="Header Instansi" checked={showAgency} onChange={setShowAgency} />
                                    </div>
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mt-4">Tata Letak</h4>
                                    <div className="space-y-2"><Toggle label="Kop Surat Halaman" checked={showPageHeader} onChange={setShowPageHeader} /></div>
                                </div>
                                <div className="space-y-3">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Aksi</h4>
                                    <Button onClick={()=>window.print()} className="w-full justify-between group h-11"><span className="font-bold">Print / Cetak</span><Icon name="Printer" size={18} className="group-hover:scale-110 transition-transform"/></Button>
                                    <Button variant="outline" onClick={downloadPDF} disabled={isGenerating} className="w-full justify-between group h-11"><span>{isGenerating ? 'Memproses...' : 'Download PDF'}</span><Icon name="Download" size={18} className="group-hover:scale-110 transition-transform text-red-500"/></Button>
                                    <Button variant="outline" onClick={exportLabelsToWord} disabled={isGenerating} className="w-full justify-between group h-11"><span>{isGenerating ? 'Memproses...' : 'Download Word'}</span><Icon name="FileText" size={18} className="group-hover:scale-110 transition-transform text-blue-600"/></Button>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-x-auto w-full">
                            <div className="bg-white p-8 min-h-screen a4-page print-area-wrapper shadow-sm border border-slate-200" id="print-area">
                                {showPageHeader && <div className="text-center mb-8 border-b-4 border-double border-black pb-4"><h2 className="text-xl font-bold uppercase tracking-widest">PEMERINTAH PROVINSI JAMBI</h2><h3 className="text-lg font-bold">DINAS PENDIDIKAN</h3><h1 className="text-2xl font-black mt-2">DAFTAR LABEL BARANG - {room ? room.name.toUpperCase() : ''}</h1></div>}
                                <style>{`
                                    .label-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 3mm; row-gap: 3mm; align-items: stretch; }
                                    .label-card { border: ${showBorder ? '2px solid black' : '1px dashed #ccc'}; background: white; font-family: "Times New Roman", Times, serif; color: black; height: 100%; display: flex; flex-direction: column; break-inside: avoid; page-break-inside: avoid; box-sizing: border-box; }
                                    .label-card-inner { padding: 4px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
                                    @media print { @page { size: A4; margin: 5mm; } .label-grid { grid-template-columns: repeat(4, 1fr) !important; gap: 3mm !important; } .label-card { border: ${showBorder ? '2px solid black !important' : 'none !important'}; height: 100% !important; } }
                                    @media (max-width: 768px) { .label-grid { grid-template-columns: repeat(2, 1fr); } } 
                                `}</style>
                                <div className="label-grid">
                                    {items.map((l, i) => (
                                        <div key={i} className="label-card">
                                            <div className="label-card-inner">
                                                {showAgency && (
                                                    <div className="flex items-center gap-1 border-b-2 border-black pb-1 mb-1">
                                                        {showLogo && <img src={appSettings.logoUrl} alt="Logo" className="h-7 w-7 object-contain" crossOrigin="anonymous"/>}
                                                        <div className={`text-center flex-1 leading-none header-text-label ${!showLogo ? 'w-full' : ''}`}>
                                                            <div className="text-[6px] font-black uppercase tracking-tight my-0.5 leading-none">BMN KEMENTERIAN<br/>KETENAGAKERJAAN RI</div>
                                                            <div className="text-[6px] font-bold uppercase mt-0.5 leading-none">SATPEL PVP JAMBI</div>
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="flex justify-between items-stretch flex-1">
                                                    <div className="flex-1 pr-1 space-y-1 flex flex-col">
                                                        <div>
                                                            <div className="flex justify-between items-end"><span className="block text-[6px] text-gray-600 uppercase font-bold tracking-wider">Kode Barang</span><span className="block text-[7px] font-black bg-black text-white px-1 rounded-sm">{l.seq}</span></div>
                                                            <span className="block text-[8px] font-bold font-mono tracking-tight bg-gray-100 px-1 border border-gray-400 inline-block w-full text-center mt-0.5">{l.code}</span>
                                                        </div>
                                                        <div className="flex-1"><span className="block text-[6px] text-gray-600 uppercase font-bold tracking-wider">Nama Barang</span><span className="block text-[8px] font-bold leading-tight line-clamp-3 overflow-hidden">{l.name}</span></div>
                                                        <div className="flex gap-1 border-t border-gray-300 pt-1 mt-auto"><div className="flex-1 min-w-0"><span className="block text-[6px] text-gray-600 uppercase font-bold">Merk/Tipe</span><span className="block text-[7px] leading-tight truncate">{l.brand} {l.model}</span></div><div className="shrink-0 text-right"><span className="block text-[6px] text-gray-600 uppercase font-bold">Thn</span><span className="block text-[7px] font-bold">{l.year || '-'}</span></div></div>
                                                    </div>
                                                    {showQr && <div className="shrink-0 flex flex-col items-center justify-center border-l-2 border-dotted border-gray-300 pl-1 w-14"><canvas id={`lbl-qr-${i}`} style={{ width: '50px', height: '50px' }}></canvas></div>}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PrintQrRoomView = ({ room, onBack }) => {
            const { appSettings } = useContext(AppContext);
            const [showInstructions, setShowInstructions] = useState(true);
            const [showDetails, setShowDetails] = useState(true);
            const [showLogo, setShowLogo] = useState(true); // New: Logo toggle for QR Room
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                setTimeout(() => {
                    const canvas = document.getElementById('room-qr-canvas');
                    if (canvas) new QRious({ element: canvas, value: `${window.location.origin}${window.location.pathname}#room-${room.id}`, size: 300 });
                }, 300);
            }, [room]);

            // For single QR, PDF and Image are good. Word is a bit odd for a single image but requested.
            const downloadPDF = async () => {
                 setIsGenerating(true);
                 const element = document.getElementById("print-area");
                 if (!element) return;
                 element.classList.add('pdf-capture-mode');
                 try {
                     const canvas = await html2canvas(element, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' });
                     const imgData = canvas.toDataURL('image/jpeg', 0.95);
                     const { jsPDF } = window.jspdf;
                     const pdf = new jsPDF('p', 'mm', 'a4');
                     const imgWidth = 210; 
                     const pageHeight = 297; 
                     const imgHeight = canvas.height * imgWidth / canvas.width;
                     pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                     pdf.save(`QR_Ruangan_${room.name}.pdf`);
                 } catch (e) { alert("Gagal membuat PDF."); } finally { element.classList.remove('pdf-capture-mode'); setIsGenerating(false); }
            };

            const exportToWord = () => {
                setIsGenerating(true);
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>QR Ruangan</title><style>body { font-family: 'Arial', sans-serif; text-align: center; }</style></head><body>";
                const footer = "</body></html>";
                
                // Construct simple HTML for Word
                const canvas = document.getElementById('room-qr-canvas');
                const qrData = canvas ? canvas.toDataURL('image/png') : '';
                
                let content = `<div style="border: 5px solid black; padding: 20px; max-width: 600px; margin: 0 auto; text-align: center;">`;
                if(showLogo) content += `<img src="${appSettings.logoUrl}" width="60" style="margin-bottom:10px;">`;
                content += `<h2 style="text-transform: uppercase; margin: 0;">RUANGAN</h2>`;
                content += `<h1 style="font-size: 30px; margin: 10px 0;">${room.name}</h1>`;
                content += `<img src="${qrData}" width="300" height="300" />`;
                if(showInstructions) content += `<p style="font-family: monospace; background: #000; color: #fff; padding: 5px; display: inline-block;">SCAN UNTUK LIHAT INVENTARIS</p>`;
                if(showDetails) {
                    content += `<table style="width: 100%; margin-top: 20px; border-top: 2px solid #000; padding-top: 10px;"><tr><td style="text-align:left;"><b>KODE:</b> ${room.code}</td><td style="text-align:right;"><b>PIC:</b> ${room.pic}</td></tr></table>`;
                }
                content += `</div>`;

                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + content + footer);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `QR_Ruangan_${room.name}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
                setIsGenerating(false);
            };
            
            return (
                <div className="space-y-6 animate-enter min-h-screen">
                    <div className="flex items-center gap-4 no-print">
                        <Button variant="outline" className="px-3" onClick={onBack}><Icon name="ArrowLeft" size={18}/></Button>
                        <div><h2 className="text-xl sm:text-2xl font-bold text-slate-900 leading-tight">Cetak QR Ruangan - {room.name}</h2><p className="text-slate-500 font-mono text-sm">Scan untuk detail inventaris ruangan</p></div>
                    </div>
                    <div className="flex flex-col md:flex-row gap-6 items-start">
                        <div className="w-full md:w-80 flex-shrink-0 print-controls space-y-4 no-print sticky top-6">
                            <div className="bg-white p-6 rounded-xl shadow-soft border border-slate-200">
                                <div className="flex items-center gap-3 mb-6 text-slate-800 border-b pb-4">
                                    <div className="p-2 bg-indigo-50 text-primary rounded-lg"><Icon name="Settings" size={20} /></div>
                                    <div><h3 className="font-bold text-lg leading-tight">Pengaturan QR</h3><p className="text-xs text-slate-500">Sesuaikan tampilan</p></div>
                                </div>
                                <div className="bg-indigo-50/50 p-3 rounded-lg border border-indigo-100 mb-6"><div className="flex justify-between items-center text-sm mb-1"><span className="text-slate-500">Total Label:</span><span className="font-bold text-indigo-700">1 Pcs</span></div><div className="flex justify-between items-center text-sm"><span className="text-slate-500">Kertas:</span><span className="font-bold text-slate-700">A4 (Portrait)</span></div></div>
                                <div className="space-y-4 mb-8">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Tampilan Kartu</h4>
                                    <div className="space-y-2"><Toggle label="Logo Instansi" checked={showLogo} onChange={setShowLogo} /><Toggle label="QR Code" checked={true} onChange={()=>{}} /> <Toggle label="Instruksi Scan" checked={showInstructions} onChange={setShowInstructions} /><Toggle label="Detail Ruangan" checked={showDetails} onChange={setShowDetails} /></div>
                                </div>
                                <div className="space-y-3">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Aksi</h4>
                                    <Button onClick={()=>window.print()} className="w-full justify-between group h-11"><span className="font-bold">Print / Cetak</span><Icon name="Printer" size={18} className="group-hover:scale-110 transition-transform"/></Button>
                                    <Button variant="outline" onClick={downloadPDF} disabled={isGenerating} className="w-full justify-between group h-11"><span>{isGenerating ? 'Memproses...' : 'Download Gambar (PNG)'}</span><Icon name="Download" size={18} className="group-hover:scale-110 transition-transform text-red-500"/></Button>
                                    <Button variant="outline" onClick={exportToWord} disabled={isGenerating} className="w-full justify-between group h-11"><span>{isGenerating ? 'Memproses...' : 'Download Word'}</span><Icon name="FileText" size={18} className="group-hover:scale-110 transition-transform text-blue-600"/></Button>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-x-auto w-full">
                            <div className="bg-gray-100 flex justify-center p-8 min-h-screen">
                                <div className="bg-white p-8 min-h-[297mm] min-w-[210mm] shadow-lg flex items-center justify-center border border-slate-200" id="print-area">
                                    <div id="qr-card-container" className="border-8 border-black p-12 text-center max-w-lg w-full bg-white relative">
                                        {showLogo && <img src={appSettings.logoUrl} alt="Logo" className="h-16 w-auto mx-auto mb-4 object-contain" crossOrigin="anonymous"/>}
                                        <h2 className="text-3xl font-black mb-2 uppercase tracking-widest">Ruangan</h2>
                                        <h3 className="text-4xl font-bold mb-10 text-primary-700">{room.name}</h3>
                                        <div className="flex justify-center mb-10 border-4 border-black p-4 inline-block rounded-xl"><canvas id="room-qr-canvas" className="w-80 h-80"></canvas></div>
                                        {showInstructions && <p className="font-mono text-lg mb-8 bg-black text-white inline-block px-4 py-1 rounded">SCAN UNTUK LIHAT INVENTARIS</p>}
                                        {showDetails && <div className="text-left text-base border-t-4 border-black pt-6 grid grid-cols-2 gap-4"><div><p className="text-xs text-gray-500 uppercase font-bold">Kode Ruangan</p><p className="font-bold text-xl">{room.code}</p></div><div className="text-right"><p className="text-xs text-gray-500 uppercase font-bold">Penanggung Jawab</p><p className="font-bold text-xl">{room.pic}</p></div></div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )
        };

        const PrintKirListView = ({ room, items, onBack, exportFn }) => {
            const { appSettings } = useContext(AppContext);
            const [showHeader, setShowHeader] = useState(true);
            const [showSignatures, setShowSignatures] = useState(true);
            const [showDate, setShowDate] = useState(true);
            const [isGenerating, setIsGenerating] = useState(false);

            const downloadPDF = async () => {
                 setIsGenerating(true);
                 const element = document.getElementById("kir-print-area");
                 if (!element) return;
                 element.classList.add('pdf-capture-mode');
                 try {
                     const canvas = await html2canvas(element, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' });
                     const imgData = canvas.toDataURL('image/jpeg', 0.95);
                     const { jsPDF } = window.jspdf;
                     const pdf = new jsPDF('p', 'mm', 'a4');
                     const imgWidth = 210; 
                     const pageHeight = 297; 
                     const imgHeight = canvas.height * imgWidth / canvas.width;
                     let heightLeft = imgHeight;
                     let position = 0;
                     pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                     heightLeft -= pageHeight;
                     while (heightLeft >= 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; }
                     pdf.save(`KIR_${room.name}_${new Date().getTime()}.pdf`);
                 } catch (e) { alert("Gagal membuat PDF."); } finally { element.classList.remove('pdf-capture-mode'); setIsGenerating(false); }
            };

            const exportToWord = () => {
                setIsGenerating(true);
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>KIR</title><style>body { font-family: 'Arial', sans-serif; }</style></head><body>";
                const footer = "</body></html>";
                const content = document.getElementById("kir-print-area").innerHTML;
                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(header + content + footer);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `KIR_${room.name}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
                setIsGenerating(false);
            };
            
            return (
                <div className="space-y-6 animate-enter min-h-screen">
                    <div className="flex items-center gap-4 no-print">
                        <Button variant="outline" className="px-3" onClick={onBack}><Icon name="ArrowLeft" size={18}/></Button>
                        <div><h2 className="text-xl sm:text-2xl font-bold text-slate-900 leading-tight">Cetak Daftar KIR - {room.name}</h2><p className="text-slate-500 font-mono text-sm">{items.length} Barang terdaftar</p></div>
                    </div>
                    <div className="flex flex-col md:flex-row gap-6 items-start">
                        <div className="w-full md:w-80 flex-shrink-0 print-controls space-y-4 no-print sticky top-6">
                            <div className="bg-white p-6 rounded-xl shadow-soft border border-slate-200">
                                <div className="flex items-center gap-3 mb-6 text-slate-800 border-b pb-4">
                                    <div className="p-2 bg-indigo-50 text-primary rounded-lg"><Icon name="Settings" size={20} /></div>
                                    <div><h3 className="font-bold text-lg leading-tight">Pengaturan KIR</h3><p className="text-xs text-slate-500">Kustomisasi Dokumen</p></div>
                                </div>
                                <div className="bg-indigo-50/50 p-3 rounded-lg border border-indigo-100 mb-6">
                                    <div className="flex justify-between items-center text-sm mb-1"><span className="text-slate-500">Total Barang:</span><span className="font-bold text-indigo-700">{items.length} Item</span></div>
                                    <div className="flex justify-between items-center text-sm"><span className="text-slate-500">Kertas:</span><span className="font-bold text-slate-700">A4 (Portrait)</span></div>
                                </div>
                                <div className="space-y-4 mb-8">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Tampilan Kartu</h4>
                                    <div className="space-y-2"><Toggle label="Kop Surat Halaman" checked={showHeader} onChange={setShowHeader} /><Toggle label="Tanda Tangan" checked={showSignatures} onChange={setShowSignatures} /><Toggle label="Tanggal Cetak" checked={showDate} onChange={setShowDate} /></div>
                                </div>
                                <div className="space-y-3">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Aksi</h4>
                                    <Button onClick={()=>window.print()} className="w-full justify-between group h-11"><span className="font-bold">Print / Cetak</span><Icon name="Printer" size={18} className="group-hover:scale-110 transition-transform"/></Button>
                                    <Button variant="outline" onClick={downloadPDF} disabled={isGenerating} className="w-full justify-between group h-11"><span>{isGenerating ? 'Memproses...' : 'Download PDF'}</span><Icon name="Download" size={18} className="group-hover:scale-110 transition-transform text-red-500"/></Button>
                                    <Button variant="outline" onClick={exportToWord} disabled={isGenerating} className="w-full justify-between group h-11"><span>{isGenerating ? 'Memproses...' : 'Download Word'}</span><Icon name="FileText" size={18} className="group-hover:scale-110 transition-transform text-blue-600"/></Button>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-x-auto w-full">
                            <div className="bg-white p-12 min-h-screen a4-page print-area-wrapper shadow-sm border border-slate-200" id="kir-print-area">
                                {showHeader && <div className="text-center mb-8 border-b-4 border-double border-black pb-4"><div className="flex justify-center items-center mb-2"><img src={appSettings.logoUrl} className="h-16 w-auto mr-4" alt="Logo" crossOrigin="anonymous" /><div><h2 className="text-xl font-bold uppercase tracking-widest">PEMERINTAH PROVINSI JAMBI</h2><h3 className="text-lg font-bold">DINAS PENDIDIKAN</h3></div></div><h1 className="text-3xl font-black mt-2 underline decoration-2 underline-offset-4">KARTU INVENTARIS RUANGAN (KIR)</h1></div>}
                                <div className="flex justify-between mb-8 text-sm flex-col md:flex-row gap-8">
                                    <table className="w-full md:w-auto"><tbody><tr><td className="w-32 font-bold py-1">Provinsi</td><td>: Jambi</td></tr><tr><td className="font-bold py-1">Unit</td><td>: Satpel PVP Jambi</td></tr><tr><td className="font-bold py-1">Ruangan</td><td>: {room.name}</td></tr></tbody></table>
                                    <table className="w-full md:w-auto"><tbody><tr><td className="w-32 font-bold py-1">Kode Ruangan</td><td>: {room.code}</td></tr><tr><td className="font-bold py-1">Penanggung Jawab</td><td>: {room.pic}</td></tr>{showDate && <tr><td className="font-bold py-1">Per Tanggal</td><td>: {new Date().toLocaleDateString('id-ID')}</td></tr>}</tbody></table>
                                </div>
                                <table className="w-full border-collapse border border-black text-sm mb-8">
                                    <thead><tr className="bg-gray-100 print:bg-gray-100"><th className="border border-black p-3 w-12 text-center">No</th><th className="border border-black p-3 text-left">Nama Barang</th><th className="border border-black p-3 text-left">Merk / Type</th><th className="border border-black p-3 w-20 text-center">Tahun</th><th className="border border-black p-3 w-20 text-center">Jumlah</th><th className="border border-black p-3 w-20 text-center">Satuan</th><th className="border border-black p-3 w-24 text-center">Kondisi</th><th className="border border-black p-3 text-left">Ket</th></tr></thead>
                                    <tbody>
                                        {items.map((item, idx) => (<tr key={idx}><td className="border border-black p-2 text-center">{idx + 1}</td><td className="border border-black p-2"><div className="font-bold">{item.name}</div><div className="text-xs italic text-gray-600">{item.code}</div></td><td className="border border-black p-2">{item.brand} / {item.model}</td><td className="border border-black p-2 text-center">{item.year}</td><td className="border border-black p-2 text-center font-bold text-lg">{item.qtyInRoom}</td><td className="border border-black p-2 text-center">{item.unit || 'Unit'}</td><td className="border border-black p-2 text-center">Baik</td><td className="border border-black p-2"></td></tr>))}
                                        {items.length === 0 && <tr><td colSpan="8" className="border border-black p-6 text-center italic text-gray-500">Tidak ada barang di ruangan ini</td></tr>}
                                    </tbody>
                                </table>
                                {showSignatures && <div className="flex justify-between mt-16 text-center break-inside-avoid flex-col md:flex-row gap-16 px-8"><div><p className="mb-20">Mengetahui,<br/><b>{appSettings.headName}</b></p><p className="font-bold underline">NIP. {appSettings.headNip}</p></div><div><p className="mb-20">Jambi, {new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}<br/><b>Penanggung Jawab Ruangan</b></p><p className="font-bold underline">{room.pic}</p><p>NIP. ..........................</p></div></div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const KIRModule = () => {
            const { data, updateData, syncData } = useContext(AppContext);
            const [roomView, setRoomView] = useState(null);
            const [formRoom, setFormRoom] = useState({});
            const [addItemModal, setAddItemModal] = useState(false);
            const [selectedItem, setSelectedItem] = useState("");
            const [qtyToAdd, setQtyToAdd] = useState(1);
            const [isEditingRoom, setIsEditingRoom] = useState(false);
            const [subView, setSubView] = useState('room-detail');

            const handleCreateRoom = (newRoomData) => {
                let newRooms;
                if (isEditingRoom) { 
                    newRooms = data.rooms.map(r => r.id === newRoomData.id ? { ...r, ...newRoomData } : r); 
                } else { 
                    newRooms = [...data.rooms, { ...newRoomData, id: Date.now(), items: [] }]; 
                }
                updateData('rooms', newRooms); 
                syncData('SYNC_ALL', { ...data, rooms: newRooms }); 
                setSubView('room-list'); // Go back to list
            };

            const handleDeleteRoom = (id, e) => {
                e.stopPropagation();
                if(!confirm("Hapus ruangan ini beserta isinya?")) return;
                const newRooms = data.rooms.filter(r => r.id !== id);
                updateData('rooms', newRooms); syncData('SYNC_ALL', { ...data, rooms: newRooms });
            };

            const openEditModal = (e, room) => { 
                e.stopPropagation();
                setFormRoom({...room});
                setIsEditingRoom(true); 
                setSubView('room-create'); // Reuse the create page for editing
            };
            
            const addItemToRoom = () => {
                if(!selectedItem) return;
                const roomIdx = data.rooms.findIndex(r => r.id === roomView.id);
                const updatedRooms = [...data.rooms];
                updatedRooms[roomIdx].items.push({ itemId: parseInt(selectedItem), qty: parseInt(qtyToAdd) });
                updateData('rooms', updatedRooms); syncData('SYNC_ALL', { ...data, rooms: updatedRooms }); setRoomView(updatedRooms[roomIdx]); setAddItemModal(false);
            };

            const removeRoomItem = (itemId) => {
                if(!confirm("Hapus barang dari ruangan?")) return;
                const roomIdx = data.rooms.findIndex(r => r.id === roomView.id);
                const updatedRooms = [...data.rooms];
                updatedRooms[roomIdx].items = updatedRooms[roomIdx].items.filter(i => i.itemId !== itemId);
                updateData('rooms', updatedRooms); syncData('SYNC_ALL', { ...data, rooms: updatedRooms }); setRoomView(updatedRooms[roomIdx]);
            }

            if (subView === 'label') return <PrintLabelView room={roomView} items={roomView.items.map(ri => { const item = data.items.find(i => i.id === ri.itemId); return { ...item, qty: ri.qty }; }).filter(i => i.id)} onBack={()=>setSubView('room-detail')} />;
            if (subView === 'qr') return <PrintQrRoomView room={roomView} onBack={()=>setSubView('room-detail')} />;
            if (subView === 'list') return <PrintKirListView room={roomView} items={roomView.items.map(ri => { const item = data.items.find(i => i.id === ri.itemId); return { ...item, qtyInRoom: ri.qty }; }).filter(i => i.id)} onBack={()=>setSubView('room-detail')} exportFn={()=>{}}/>;
            
            // New Create/Edit Room View
            if (subView === 'room-create') return <RoomCreate onBack={() => { setSubView('room-list'); setIsEditingRoom(false); setFormRoom({}); }} initialData={isEditingRoom ? formRoom : null} />;

            if (roomView) {
                return (
                    <div className="space-y-6 animate-enter">
                        <div className="flex items-center gap-4"><Button variant="outline" className="px-3" onClick={()=>setRoomView(null)}><Icon name="ArrowLeft"/></Button><h2 className="text-xl sm:text-2xl font-bold truncate">{roomView.name}</h2></div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Card className="p-6 space-y-4">
                                <h3 className="font-bold border-b pb-2">Info Ruangan</h3>
                                <p className="text-sm"><b>Kode:</b> {roomView.code || "-"}</p>
                                <p className="text-sm"><b>PIC:</b> {roomView.pic}</p>
                                <div className="flex flex-col gap-2 mt-4 pt-4 border-t border-dashed">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase">Aksi Cetak</h4>
                                    <Button variant="outline" size="sm" onClick={()=>setSubView('list')}><Icon name="Printer"/> Cetak KIR (Daftar)</Button>
                                    <Button variant="outline" size="sm" onClick={()=>setSubView('qr')}><Icon name="FileBadge"/> Cetak QR Ruangan</Button>
                                    <Button variant="outline" size="sm" onClick={()=>setSubView('label')}><Icon name="Package"/> Cetak Label Barang</Button>
                                </div>
                            </Card>
                            <Card className="md:col-span-2 p-6">
                                <div className="flex justify-between items-center mb-4 flex-wrap gap-2"><h3 className="font-bold">Daftar Barang</h3><Button size="sm" onClick={()=>setAddItemModal(true)}>+ Tambah</Button></div>
                                <div className="space-y-2">{roomView.items.map((ri, i) => { const item = data.items.find(it => it.id === ri.itemId); return (<div key={i} className="flex justify-between p-3 border rounded-lg hover:bg-slate-50 items-center"><div className="overflow-hidden"><span className="font-bold block truncate">{item?.name || "Unknown"}</span><span className="text-xs text-slate-500">{item?.code}</span></div><div className="flex items-center gap-3 shrink-0"><Badge color="blue">{ri.qty} {item?.unit || 'Unit'}</Badge><button className="text-red-400 hover:text-red-600 p-1" onClick={()=>removeRoomItem(ri.itemId)}><Icon name="Trash" size={16}/></button></div></div>) })}{roomView.items.length === 0 && <p className="text-slate-400 italic text-sm text-center py-4">Ruangan kosong.</p>}</div>
                            </Card>
                        </div>
                        <Modal isOpen={addItemModal} onClose={()=>setAddItemModal(false)} title="Tambah ke Ruangan">
                            <div className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Pilih Barang</label><select className="w-full h-10 border rounded-lg px-2 text-sm bg-white" onChange={e=>setSelectedItem(e.target.value)}><option value="">-- Pilih --</option>{data.items.map(i => <option key={i.id} value={i.id}>{i.name} (Sisa: {i.stock})</option>)}</select></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Jumlah</label><Input type="number" value={qtyToAdd} onChange={e=>setQtyToAdd(e.target.value)} placeholder="Jumlah"/></div><Button className="w-full mt-4" onClick={addItemToRoom}>Tambahkan</Button></div>
                        </Modal>
                    </div>
                )
            }
            return (
                <div className="space-y-6 animate-enter">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">KIR & Ruangan</h2><Button onClick={() => { setIsEditingRoom(false); setSubView('room-create'); }} className="px-3"><Icon name="Plus"/><span className="hidden sm:inline"> Ruangan Baru</span></Button></div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {data.rooms.map(r => (
                            <div key={r.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-all group cursor-pointer" onClick={() => setRoomView(r)}>
                                <div className="p-4 pb-2">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-3">
                                            {/* Icon Box */}
                                            <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center shrink-0">
                                                <Icon name="Building" size={24} />
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-lg text-slate-900 leading-tight line-clamp-1">{r.name}</h3>
                                                <span className="inline-block px-2 py-0.5 bg-slate-100 text-slate-500 text-[10px] font-bold rounded mt-1">{r.code || 'NO CODE'}</span>
                                            </div>
                                        </div>
                                        {/* Actions - Always Visible */}
                                        <div className="flex gap-1">
                                            <button onClick={(e) => openEditModal(e, r)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors" title="Edit"><Icon name="Edit" size={16} /></button>
                                            <button onClick={(e) => handleDeleteRoom(r.id, e)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors" title="Hapus"><Icon name="Trash" size={16} /></button>
                                        </div>
                                    </div>
                                    
                                    {/* Details */}
                                    <div className="space-y-2 mb-2">
                                        <div className="flex items-center gap-2 text-xs text-slate-600">
                                            <Icon name="User" size={14} className="text-slate-400"/>
                                            <span className="truncate">{r.pic || 'Belum ada PIC'}</span>
                                        </div>
                                        {(r.department || r.subDepartment) && (
                                            <div className="flex flex-wrap gap-1">
                                                {r.department && <span className="px-2 py-0.5 bg-blue-50 text-blue-700 text-[10px] font-bold rounded border border-blue-100">{r.department}</span>}
                                                {r.subDepartment && <span className="px-2 py-0.5 bg-slate-50 text-slate-600 text-[10px] font-medium rounded border border-slate-100">{r.subDepartment}</span>}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Footer / Stats */}
                                <div className="bg-slate-50 px-4 py-2 border-t border-slate-100 flex justify-between items-center text-xs">
                                    <span className="text-slate-500">Total Aset</span>
                                    <span className="font-bold text-slate-800 bg-white px-2 py-1 rounded border border-slate-200 shadow-sm">{r.items.length} Item</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SettingsPage = () => {
            const { appSettings, setAppSettings, syncData, scriptUrl, setScriptUrl } = useContext(AppContext);
            const [localForm, setLocalForm] = useState(appSettings);
            const [localScript, setLocalScript] = useState(scriptUrl);
            const fileInputRef = useRef(null);

            useEffect(() => { setLocalForm(appSettings); setLocalScript(scriptUrl); }, [appSettings, scriptUrl]);

            const handleSave = () => {
                setAppSettings(localForm);
                setScriptUrl(localScript);
                syncData('SYNC_ALL'); 
                alert("Pengaturan berhasil disimpan!");
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => {
                    setLocalForm(prev => ({...prev, logoUrl: reader.result}));
                };
                reader.readAsDataURL(file);
            };

            return (
                <div className="space-y-6 animate-enter pb-10">
                    <h2 className="text-2xl font-bold text-slate-800">Pengaturan</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Card className="p-6 border-l-4 border-indigo-500">
                            <div className="flex items-center gap-3 mb-4 border-b pb-3"><div className="p-2 bg-indigo-50 rounded-lg text-primary"><Icon name="Database" /></div><div><h3 className="font-bold text-lg text-slate-800">Konfigurasi Database</h3><p className="text-xs text-slate-500">Hubungkan aplikasi dengan Google Apps Script</p></div></div>
                            <div className="space-y-4"><div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">URL Web App</label><div className="flex gap-2"><Icon name="Link" className="mt-2.5 text-slate-400" size={18}/><Input value={localScript} onChange={e => setLocalScript(e.target.value)} placeholder="https://script.google.com/..." className="font-mono text-xs" /></div></div></div>
                        </Card>
                        <Card className="p-6 border-l-4 border-indigo-500">
                            <div className="flex items-center gap-3 mb-4 border-b pb-3"><div className="p-2 bg-indigo-50 rounded-lg text-primary"><Icon name="Image" /></div><div><h3 className="font-bold text-lg text-slate-800">Logo Instansi</h3><p className="text-xs text-slate-500">Logo ini akan muncul di semua cetakan</p></div></div>
                            <div className="flex items-center gap-4">
                                <div className="h-20 w-20 border rounded-lg flex items-center justify-center bg-gray-50 overflow-hidden"><img src={localForm.logoUrl} alt="Preview" className="h-full w-full object-contain" /></div>
                                <div className="flex-1 space-y-2">
                                    <Input placeholder="Atau paste URL logo..." value={localForm.logoUrl} onChange={e => setLocalForm({...localForm, logoUrl: e.target.value})} />
                                    <div className="flex gap-2"><Button size="sm" variant="outline" onClick={() => fileInputRef.current.click()}>Upload Gambar</Button><Button size="sm" variant="ghost" onClick={() => setLocalForm({...localForm, logoUrl: DEFAULT_LOGO})}>Reset</Button></div>
                                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleLogoUpload}/>
                                </div>
                            </div>
                        </Card>
                    </div>
                    <Card className="p-6 max-w-3xl">
                        <div className="flex items-center gap-3 mb-4 border-b pb-3"><div className="p-2 bg-indigo-50 rounded-lg text-primary"><Icon name="User" /></div><div><h3 className="font-bold text-lg text-slate-800">Pejabat Penandatangan</h3><p className="text-xs text-slate-500">Data ini akan muncul di laporan KIR dan Label</p></div></div>
                        <div className="space-y-6"><div><h4 className="font-bold text-slate-600 mb-2 text-sm bg-slate-50 p-2 rounded inline-block">Administrasi BMN</h4><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Nama</label><Input value={localForm.adminName} onChange={e => setLocalForm({...localForm, adminName: e.target.value})} /></div><div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">NIP</label><Input value={localForm.adminNip} onChange={e => setLocalForm({...localForm, adminNip: e.target.value})} /></div></div></div><div><h4 className="font-bold text-slate-600 mb-2 text-sm bg-slate-50 p-2 rounded inline-block">Kepala Satpel</h4><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">Nama</label><Input value={localForm.headName} onChange={e => setLocalForm({...localForm, headName: e.target.value})} /></div><div><label className="text-xs font-bold text-slate-500 uppercase block mb-1">NIP</label><Input value={localForm.headNip} onChange={e => setLocalForm({...localForm, headNip: e.target.value})} /></div></div></div></div>
                    </Card>
                    <div className="max-w-3xl"><Button onClick={handleSave} className="w-full h-12 text-lg shadow-lg"><Icon name="Save" /> Simpan Semua Pengaturan</Button></div>
                </div>
            )
        };

        const LoansView = ({ setView }) => <div className="p-4 text-center text-slate-500 bg-white rounded-lg shadow">Fitur Peminjaman (Placeholder)</div>;
        const CreateLoan = ({ onBack, setView }) => <div className="p-4"><Button onClick={onBack}>Kembali</Button> Form Peminjaman</div>;
        const MaintenanceView = () => <div className="p-4 text-center text-slate-500 bg-white rounded-lg shadow">Fitur Maintenance (Placeholder)</div>;
        const QrInventoryView = ({id}) => <div className="p-4">Scan Ruangan: {id}</div>;
        const QrItemView = ({id}) => <div className="p-4">Scan Barang: {id}</div>;

        const MainContent = () => {
            const [view, setView] = useState('dashboard');
            const [detailItem, setDetailItem] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [desktopSidebarOpen, setDesktopSidebarOpen] = useState(true);
            const [qrData, setQrData] = useState(null); 

            useEffect(() => {
                const checkHash = () => { const hash = window.location.hash; if(hash.startsWith('#room-')) setQrData({ type: 'room', id: hash.replace('#room-', '') }); else if(hash.startsWith('#item-')) setQrData({ type: 'item', id: hash.replace('#item-', '') }); else setQrData(null); };
                window.addEventListener('hashchange', checkHash); checkHash(); return () => window.removeEventListener('hashchange', checkHash);
            }, []);

            if (qrData?.type === 'room') return <QrInventoryView id={qrData.id} />;
            if (qrData?.type === 'item') return <QrItemView id={qrData.id} />;

            return (
                <div className="flex min-h-screen bg-slate-50 font-sans text-slate-900 overflow-x-hidden">
                    <Sidebar view={view} setView={setView} open={sidebarOpen} setOpen={setSidebarOpen} desktopOpen={desktopSidebarOpen} />
                    <main className={cn("flex-1 transition-all duration-300 flex flex-col min-h-screen w-full", desktopSidebarOpen ? "md:ml-64" : "md:ml-0")}>
                        <DesktopHeader toggleSidebar={() => setDesktopSidebarOpen(!desktopSidebarOpen)} />
                        <header className="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sticky top-0 z-30 shadow-sm no-print"><button onClick={() => setSidebarOpen(true)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-600"><Icon name="Menu" size={24}/></button><span className="font-bold text-slate-800">SIBA Enterprise</span><div className="w-10"></div></header>
                        <div className="p-4 sm:p-6 lg:p-8 flex-1 overflow-x-hidden"><div className="max-w-7xl mx-auto w-full">
                            {view === 'dashboard' && <Dashboard />}
                            {view === 'inventory' && <Inventory setView={setView} setDetailItem={setDetailItem} />}
                            {view === 'inventory-create' && <InventoryCreate onBack={() => setView('inventory')} />}
                            {view === 'inventory-detail' && <InventoryDetail item={detailItem} onBack={() => setView('inventory')} />}
                            {view === 'loans' && <LoansView setView={setView} />}
                            {view === 'loans_create' && <CreateLoan onBack={() => setView('loans')} setView={setView} />}
                            {view === 'kir' && <KIRModule />}
                            {view === 'maintenance' && <MaintenanceView />}
                            {view === 'settings' && <SettingsPage />}
                        </div></div>
                    </main>
                </div>
            );
        };

        const App = () => (
            <AppProvider><MainContent /></AppProvider>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
